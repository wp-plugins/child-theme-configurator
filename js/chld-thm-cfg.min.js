/*!
 *  Script: chld-thm-cfg.js
 *  Plugin URI: http://www.lilaeamedia.com/plugins/child-theme-configurator/
 *  Description: Handles jQuery, AJAX and other UI
 *  Version: 1.0.1
 *  Author: Lilaea Media
 *  Author URI: http://www.lilaeamedia.com/
 *  License: GPLv2
 *  Copyright (C) 2013 Lilaea Media
 */
(function(e){var k="\n",l=function(m){e(m).iris({change:function(){h(m)}})},h=function(s){var o=/^(ctc_(ovrd_)?(parent|child)_([a-z\-]+)_(\d+))(_\w+)?$/,t=e(s).parents(".ctc-selector-row, .ctc-parent-row").first(),r=t.find(".ctc-swatch").first(),q={parent:{},child:{}},p={parent:{origin:"",start:"",end:""},child:{origin:"",start:"",end:""}},n={child:false,parent:false},m={};t.find(".ctc-parent-value, .ctc-child-value").each(function(){var z=e(this).attr("id"),u=z.match(o),v=u[3],C=(undefined==u[4]?"":u[4]),A=u[5],y=(undefined==u[6]?"":u[6]),B=("parent"==v?e(this).text():e(this).val()),x,w;if("child"==v){m[z]=B}if(a(B)){return}if(false===a(y)){switch(y){case"_border_width":q[v][C+"-width"]=B;break;case"_border_style":q[v][C+"-style"]=B;break;case"_border_color":q[v][C+"-color"]=B;break;case"_background_url":q[v]["background-image"]=b(v,B);break;case"_background_color":q[v]["background-color"]=s.value;break;case"_background_color1":p[v].start=B;n[v]=true;break;case"_background_color2":p[v].end=B;n[v]=true;break;case"_background_origin":p[v].origin=B;n[v]=true;break}}else{if(x=C.match(/^border(\-(top|right|bottom|left))?$/)&&!B.match(/none/)){w=B.split(/ +/);q[v][C+"-width"]=undefined==w[0]?"":w[0];q[v][C+"-style"]=undefined==w[1]?"":w[1];q[v][C+"-color"]=undefined==w[2]?"":w[2]}else{if("background-image"==C){if(B.match(/url\(/)){q[v]["background-image"]=b(v,B)}else{w=B.split(/ +/);if(w.length>2){p[v].origin=undefined==w[0]?"top":w[0];p[v].start=undefined==w[1]?"transparent":w[1];p[v].end=undefined==w[2]?"transparent":w[2];n[v]=true}else{q[v]["background-image"]=B}}}else{q[v][C]=B}}}});if(undefined!=r){e(r).removeAttr("style");if(n.parent){e(r).ctcgrad(p.parent.origin,[p.parent.start,p.parent.end])}e(r).css(q.parent);if(!(r.attr("id").match(/parent/))){if(n.child){e(r).ctcgrad(p.child.origin,[p.child.start,p.child.end])}e(r).css(q.child)}}return m},j=function(p){var o,m,n;if(undefined!=p.imports){ctcAjax.imports[ctcAjax.child_theme]=p.imports}e(p.del).each(function(){if(undefined!=this.selnum){delete ctcAjax.val_ndx[ctcAjax.child_theme][this.rule][this.value][this.query][this.selnum]}else{if(undefined!=this.query){delete ctcAjax.val_ndx[ctcAjax.child_theme][this.rule][this.value][this.query]}else{if(undefined!=this.value){delete ctcAjax.val_ndx[ctcAjax.child_theme][this.rule][this.value]}else{if(undefined!=this.rule){delete ctcAjax.val_ndx[ctcAjax.child_theme][this.rule]}}}}if(undefined!=this.query){o=this.query}if(undefined!=this.selnum){m=this.selnum}if(undefined!=this.rule){n=this.rule}});e(p.insert).each(function(){ctcAjax.sel_ndx[this.query][this.selector]=this.selnum;ctcAjax.data[this.selnum]={selector:this.selector,query:this.query,value:{}};if(undefined!=this.query){o=this.query}if(undefined!=this.selnum){m=this.selnum}if(undefined!=this.rule){n=this.rule}});e(p.update).each(function(){if(undefined==ctcAjax.val_ndx[ctcAjax.child_theme]){ctcAjax.val_ndx[ctcAjax.child_theme]={}}if(undefined==ctcAjax.val_ndx[ctcAjax.child_theme][this.rule]){ctcAjax.val_ndx[ctcAjax.child_theme][this.rule]={}}if(this.value&&undefined==ctcAjax.val_ndx[ctcAjax.child_theme][this.rule][this.value]){ctcAjax.val_ndx[ctcAjax.child_theme][this.rule][this.value]={}}if(this.value&&undefined==ctcAjax.val_ndx[ctcAjax.child_theme][this.rule][this.value][this.query]){ctcAjax.val_ndx[ctcAjax.child_theme][this.rule][this.value][this.query]={}}if(this.value&&undefined==ctcAjax.val_ndx[ctcAjax.child_theme][this.rule][this.value][this.query][this.selnum]){ctcAjax.val_ndx[ctcAjax.child_theme][this.rule][this.value][this.query][this.selnum]=0}if(this.rule&&undefined==ctcAjax.data[this.selnum].value[this.rule]){ctcAjax.data[this.selnum].value[this.rule]={}}ctcAjax.data[this.selnum].value[this.rule][ctcAjax.child_theme]=this.value+(this.important>0?" !important":"");if(undefined!=this.query){o=this.query}if(undefined!=this.selnum){m=this.selnum}if(undefined!=this.rule){n=this.rule}});if(o){ctc_set_query(o,o)}if(m){ctc_set_selector(m,ctcAjax.data[m].selector)}if(n){ctc_set_rule(n,n)}},b=function(q,n){var p=n.match(/url\([" ]*(.+?)[" ]*\)/),o=(undefined==p?null:p[1]),m=ctcAjax.theme_uri+"/"+("parent"==q?ctcAjax.parent_theme:ctcAjax.child_theme)+"/",r;if(!o){return false}else{if(o.match(/^(http:|\/)/)){r=n}else{r="url("+m+o+")"}}return r},a=function(n){if(undefined==n||false===n||null===n||""===n||0===n){return true}if(true===n||"string"===typeof n||"number"===typeof n){return false}if("object"===typeof n){for(var m in n){if(n.hasOwnProperty(m)){return false}}return true}return false},g=function(){var m=[];if(false===a(ctcAjax.sel_ndx)){e.each(ctcAjax.sel_ndx,function(n,o){obj={label:n,value:n};m.push(obj)})}return m},d=function(n){var m=[];if(false===a(ctcAjax.sel_ndx[n])){e.each(ctcAjax.sel_ndx[n],function(o,p){obj={label:o,value:p};m.push(obj)})}return m},i=function(){var n={},m=[];if(false===a(ctcAjax.val_ndx[ctcAjax.parent_theme])){e.each(ctcAjax.val_ndx[ctcAjax.parent_theme],function(o,p){n[o]++})}if(false===a(ctcAjax.val_ndx[ctcAjax.child_theme])){e.each(ctcAjax.val_ndx[ctcAjax.child_theme],function(o,p){n[o]++})}e.each(["border-width","border-style","border-color","padding","margin","background","font"],function(){n[this]++});if(false===a(n)){e.each(n,function(o,p){m.push(o)})}return m.sort()},f=function(r,s,n){var o="",q=(undefined==ctcAjax.data[r].value||undefined==ctcAjax.data[r].value[s]?"":ctcAjax.data[r].value[s]),p=ctc_decode_value(s,(undefined==q?"":q[ctcAjax.parent_theme])),m=ctc_decode_value(s,(undefined==q?"":q[ctcAjax.child_theme]));if(q){unique_rule_value[s+"%%"+q[ctcAjax.parent_theme]]=1;unique_rule_value[s+"%%"+q[ctcAjax.child_theme]]=1}o+='<div class="ctc-'+(n?"selector":"input")+'-row clearfix">'+k;o+='<div class="ctc-input-cell">'+(n?ctcAjax.data[r].selector:s)+"</div>"+k;o+='<div class="ctc-parent-value'+(n?" ctc-hidden":" ctc-input-cell")+'" id="ctc_parent_'+s+"_"+r+'">'+(a(p.orig)?"[no value]":p.orig)+"</div>"+k;o+='<div class="ctc-input-cell">'+k;if(false===a(p.names)){e.each(p.names,function(t,u){u=(a(u)?"":u);o+='<div class="ctc-child-input-cell">'+k;var w="ctc_"+(n?"":"ovrd_")+"child_"+s+"_"+r+u,v;if(!(v=m.values.shift())){v=""}o+=(a(u)?"":ctcAjax.labels[u]+":<br/>")+'<input type="text" id="'+w+'" name="'+w+'" class="ctc-child-value'+((u+s).match(/color/)?" color-picker":"")+((u).match(/url/)?" ctc-input-wide":"")+'" value="'+v+'" />'+k;o+="</div>"+k})}o+="</div>"+k;o+=(n?'<div class="ctc-swatch ctc-specific" id="ctc_child_'+s+"_"+r+'_swatch">'+ctcAjax.swatch_text+"</div>"+k+'<div class="ctc-child-input-cell ctc-button-cell" id="ctc_save_'+s+"_"+r+'_cell">'+k+'<input type="button" class="button ctc-save-input" id="ctc_save_'+s+"_"+r+'" name="ctc_save_'+s+"_"+r+'" value="Save" /></div>'+k:"");o+="</div><!-- end input row -->"+k;return o},c=function(o){if(undefined==ctcAjax.data[o].value){return}var n="",m=0;if(false===a(ctcAjax.data[o].value)){e.each(ctcAjax.data[o].value,function(q,p){n+=f(o,q,false)})}e("#ctc_sel_ovrd_rule_inputs").html(n).find(".color-picker").each(function(){l(this)});h("#ctc_child_all_0_swatch")};ctc_render_rule_value_inputs=function(p){var n='<div class="ctc-input-row clearfix" id="ctc_rule_row_'+p+'">'+k,o=0,m={parent:ctcAjax.parent_theme,child:ctcAjax.child_theme};unique_rule_value={},e.each(m,function(q,r){if(a(ctcAjax.val_ndx[r])||undefined==ctcAjax.val_ndx[r][p]){return}e.each(ctcAjax.val_ndx[r][p],function(t,s){if(unique_rule_value[p+"%%"+t]){return}else{o++;oldRuleObj=ctc_decode_value(p,t),n+='<div class="ctc-parent-row clearfix" id="ctc_rule_row_'+p+"_"+o+'">'+k;n+='<div class="ctc-input-cell ctc-parent-value" id="ctc_parent_'+p+"_"+o+'">'+oldRuleObj.orig+"</div>"+k;n+='<div class="ctc-input-cell">'+k;n+='<div class="ctc-swatch ctc-specific" id="ctc_parent_'+p+"_"+o+'_swatch">'+ctcAjax.swatch_text+"</div></div>"+k;n+='<div class="ctc-input-cell"><a href="#" class="ctc-selector-handle" id="ctc_selector_'+p+"_"+o+'">'+ctcAjax.selector_text+"</a></div>"+k;n+='<div id="ctc_selector_'+p+"_"+o+'_container" class="ctc-selector-container clearfix">'+k;n+='<a href="#" id="ctc_selector_'+p+"_"+o+'_close" class="ctc-selector-handle" style="float:right">'+ctcAjax.close_text+"</a>"+k;n+=ctc_render_selector_value_inputs(p,s);n+="</div></div>"+k}})});n+="</div>"+k;e("#ctc_rule_value_inputs").html(n).find(".color-picker").each(function(){l(this)});e("#ctc_rule_value_inputs").find(".ctc-swatch").each(function(){h(this)})},ctc_render_selector_value_inputs=function(q,o){var m="",p="",n;if(false===a(o)){e.each(o,function(s,r){if(s!=p){p=s;m+='<h4 class="ctc-query-heading">'+s+"</h4>"+k}if(false===a(r)){e.each(r,function(u,t){m+=f(u,q,true)})}})}return m},ctc_save=function(q){var p={},r,o,m,n;e(q).prop("disabled",true);e(".ctc-status-icon").remove();e(q).parent(".ctc-textarea-button-cell, .ctc-button-cell").append('<span class="ctc-status-icon spinner"></span>');e(".spinner").show();if((r=e("#ctc_new_selectors"))&&"ctc_save_new_selectors"==e(q).attr("id")){p.ctc_new_selectors=r.val();if(o=e("#ctc_sel_ovrd_query_selected")){p.ctc_sel_ovrd_query=o.text()}}else{if((m=e("#ctc_child_imports"))&&"ctc_save_imports"==e(q).attr("id")){p.ctc_child_imports=m.val()}else{p=h(q)}}p.action="ctc_update";p._wpnonce=e("#_wpnonce").val();e.post(ctcAjax.ajaxurl,p,function(s){e(q).prop("disabled",false);e(".ctc-status-icon").removeClass("spinner");if(a(s)){e(".ctc-status-icon").addClass("failure")}else{e(".ctc-status-icon").addClass("success");e("#ctc_new_selectors").val("");j(s)}return false},"json").fail(function(){e(q).prop("disabled",false);e(".ctc-status-icon").removeClass("spinner");e(".ctc-status-icon").addClass("failure")});return false},ctc_serialize=function(n){var m;if(undefined==n){m=""}else{if("string"===typeof n||"number"===typeof n){m=n}else{if("object"===typeof n){m="";e.each(n,function(o,p){m+=o+": "+p+",\n"})}}}return m},ctc_decode_value=function(o,m){m=(undefined==m?"":m);var n={orig:m};if(o.match(/^border(\-(top|right|bottom|left))?$/)){var p=m.split(/ +/);n.names=["_border_width","_border_style","_border_color"];n.values=[(undefined==p[0]?"":p[0]),(undefined==p[1]?"":p[1]),(undefined==p[2]?"":p[2])]}else{if(o.match(/^background\-image/)){n.names=["_background_url","_background_origin","_background_color1","_background_color2"];n.values=["","","",""];if(m.match(/:/)){var p=m.split(/:/);n.values[1]=(undefined==p[0]?"":p[0]);n.values[2]=(undefined==p[1]?"":p[1]);n.values[3]=(undefined==p[3]?"":p[3]);n.orig=[n.values[1],n.values[2],n.values[3]].join(" ")}else{n.values[0]=m}}else{n.names=[""];n.values=[m]}}return n},ctc_set_query=function(n,m){e("#ctc_sel_ovrd_query").val("");e("#ctc_sel_ovrd_query_selected").text(m);ctc_selectors=d(n);e("#ctc_sel_ovrd_selector").autocomplete("option",{source:ctc_selectors});e("#ctc_new_selector_row").show()},ctc_set_selector=function(n,m){e("#ctc_sel_ovrd_selector").val("");e("#ctc_sel_ovrd_selector_selected").text(m);e("#ctc_sel_ovrd_selnum").val(n);c(n);e("#ctc_sel_ovrd_new_rule, #ctc_sel_ovrd_rule_header,#ctc_sel_ovrd_rule_inputs_container,#ctc_sel_ovrd_rule_inputs").show()},ctc_set_rule=function(n,m){e("#ctc_rule_menu").val("");e("#ctc_rule_menu_selected").text(m);ctc_render_rule_value_inputs(n);e("#ctc_rule_value_inputs,#ctc_input_row_rule_header").show()},ctc_selectors=[],ctc_queries=g(),ctc_rules=i(),unique_rule_value={},toggles={};e(".color-picker").each(function(){l(this)});e(".ctc-option-panel-container").on("focus",".color-picker",function(){e(this).iris("toggle");e(".iris-picker").css({position:"absolute","z-index":10})});e(".ctc-option-panel-container").on("focus","input",function(){e(".color-picker").not(this).iris("hide")});e(".ctc-option-panel-container").on("change",".ctc-child-value",function(){h(this)});e(".ctc-option-panel-container").on("click",".ctc-selector-handle",function(m){m.preventDefault();var n=e(this).attr("id").replace("_close","");e("#"+n+"_container").fadeToggle("fast");e(".ctc-selector-container").not("#"+n+"_container").fadeOut("fast")});e(".nav-tab").on("click",function(n){n.preventDefault();var o="#"+e(this).attr("id"),m=o+"_panel";e(".nav-tab").removeClass("nav-tab-active");e(".ctc-option-panel").removeClass("ctc-option-panel-active");e(".ctc-selector-container").hide();e(o).addClass("nav-tab-active");e(".ctc-option-panel-container").scrollTop(0);e(m).addClass("ctc-option-panel-active")});e("#preview_options").on("click",function(o){var m=new Date().getTime(),n=ctcAjax.theme_uri+"/"+ctcAjax.child_theme+"/style.css?"+m;e.get(n,function(p){e("#preview_options_panel").text(p)}).fail(function(){e("#preview_options_panel").text(ctcAjax.css_fail)})});e("#ctc_load_form").on("submit",function(m){return confirm(ctcAjax.load_msg)});e(document).on("click",".ctc-save-input",function(m){ctc_save(this)});e("#ctc_sel_ovrd_query").autocomplete({source:ctc_queries,minLength:0,selectFirst:true,autoFocus:true,select:function(n,m){ctc_set_query(m.item.value,m.item.label);return false},focus:function(m){m.preventDefault()}});e("#ctc_sel_ovrd_selector").autocomplete({source:ctc_selectors,selectFirst:true,autoFocus:true,select:function(n,m){ctc_set_selector(m.item.value,m.item.label);return false},focus:function(m){m.preventDefault()}});e("#ctc_rule_menu").autocomplete({source:ctc_rules,selectFirst:true,autoFocus:true,select:function(n,m){ctc_set_rule(m.item.value,m.item.label);return false},focus:function(m){m.preventDefault()}});e("#ctc_new_rule_menu").autocomplete({source:ctc_rules,selectFirst:true,autoFocus:true,select:function(o,n){var m=e("#ctc_sel_ovrd_selnum").val();e("#ctc_sel_ovrd_rule_inputs").append(f(m,n.item.value,false)).find(".color-picker").each(function(){l(this)});e("#ctc_new_rule_menu").val("");return false},focus:function(m){m.preventDefault()}})})(jQuery);